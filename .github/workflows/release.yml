name: Release Notes

on:
  push:
    branches: [ main ]

permissions:
  contents: write
  pull-requests: read
  issues: read

jobs:
  create-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y.%m.%d')" >> $GITHUB_OUTPUT

      - name: Get latest tag
        id: latest_tag
        run: |
          latest_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          echo "tag=$latest_tag" >> $GITHUB_OUTPUT
          echo "Latest tag: $latest_tag"

      - name: Generate version
        id: version
        run: |
          if [ -f "package.json" ]; then
            # package.jsonì—ì„œ ë²„ì „ ì¶”ì¶œ
            VERSION=$(jq -r '.version' package.json)
            echo "Found version in package.json: $VERSION"
          else
            # ë‚ ì§œ ê¸°ë°˜ ë²„ì „ ìƒì„±
            VERSION="${{ steps.date.outputs.date }}"
            echo "Generated date-based version: $VERSION"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Check if tag exists
        id: tag_exists
        run: |
          if git rev-parse "v${{ steps.version.outputs.version }}" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Tag v${{ steps.version.outputs.version }} already exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Tag v${{ steps.version.outputs.version }} does not exist"
          fi

      - name: Get commit messages since last tag
        id: commits
        run: |
          if [ -n "${{ steps.latest_tag.outputs.tag }}" ]; then
            # ë§ˆì§€ë§‰ íƒœê·¸ ì´í›„ ì»¤ë°‹ë“¤
            commits=$(git log ${{ steps.latest_tag.outputs.tag }}..HEAD --oneline --pretty=format:"- %s (%h)" | head -20)
          else
            # íƒœê·¸ê°€ ì—†ìœ¼ë©´ ìµœê·¼ 20ê°œ ì»¤ë°‹
            commits=$(git log --oneline --pretty=format:"- %s (%h)" | head -20)
          fi
          
          # ë©€í‹°ë¼ì¸ ì¶œë ¥ ì²˜ë¦¬
          echo "commits<<EOF" >> $GITHUB_OUTPUT
          echo "$commits" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Get changed files
        id: changed_files
        run: |
          if [ -n "${{ steps.latest_tag.outputs.tag }}" ]; then
            changed_files=$(git diff --name-only ${{ steps.latest_tag.outputs.tag }}..HEAD | head -10)
          else
            changed_files=$(git diff --name-only HEAD~5..HEAD | head -10)
          fi
          
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$changed_files" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Get commit count
        id: commit_count
        run: |
          if [ -n "${{ steps.latest_tag.outputs.tag }}" ]; then
            count=$(git rev-list --count ${{ steps.latest_tag.outputs.tag }}..HEAD)
          else
            count=$(git rev-list --count HEAD)
          fi
          echo "count=$count" >> $GITHUB_OUTPUT

      - name: Generate release notes
        id: release_notes
        run: |
          cat > release_notes.md << 'EOF'
          ## ğŸš€ Release v${{ steps.version.outputs.version }}
          
          ### ğŸ“ ë³€ê²½ì‚¬í•­ (${{ steps.commit_count.outputs.count }}ê°œ ì»¤ë°‹)
          ${{ steps.commits.outputs.commits }}
          
          ### ğŸ“Š ë¦´ë¦¬ìŠ¤ ì •ë³´
          - **ë²„ì „**: v${{ steps.version.outputs.version }}
          - **ë¦´ë¦¬ìŠ¤ ë‚ ì§œ**: ${{ steps.date.outputs.date }}
          - **ë¸Œëœì¹˜**: ${{ github.ref_name }}
          - **ì»¤ë°‹**: ${{ github.sha }}
          - **ë°°í¬ì**: ${{ github.actor }}
          
          ### ğŸ”— ë§í¬
          - [ì „ì²´ ë³€ê²½ì‚¬í•­](https://github.com/${{ github.repository }}/compare/${{ steps.latest_tag.outputs.tag }}...v${{ steps.version.outputs.version }})
          - [ì»¤ë°‹ íˆìŠ¤í† ë¦¬](https://github.com/${{ github.repository }}/commits/main)
          EOF
          
          # íŒŒì¼ ë‚´ìš©ì„ GitHub Outputì— ì €ì¥
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          cat release_notes.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        if: steps.tag_exists.outputs.exists == 'false'
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.version.outputs.version }}
          release_name: Release v${{ steps.version.outputs.version }}
          body: ${{ steps.release_notes.outputs.notes }}
          draft: false
          prerelease: false

      - name: Update existing release
        if: steps.tag_exists.outputs.exists == 'true'
        run: |
          echo "Tag already exists. Skipping release creation."
          echo "You can manually update the release at:"
          echo "https://github.com/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.version }}"

      - name: Create release notes file
        run: |
          mkdir -p docs/releases
          cat > docs/releases/v${{ steps.version.outputs.version }}.md << 'EOF'
          ${{ steps.release_notes.outputs.notes }}
          EOF

      - name: Commit release notes file
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add docs/releases/v${{ steps.version.outputs.version }}.md
          git commit -m "ğŸ“ Add release notes for v${{ steps.version.outputs.version }}" || exit 0
          git push

      - name: Success notification
        run: |
          echo "ğŸ‰ ë¦´ë¦¬ìŠ¤ ë…¸íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo "ğŸ“ ë²„ì „: v${{ steps.version.outputs.version }}"
          echo "ğŸ“Š ì»¤ë°‹ ìˆ˜: ${{ steps.commit_count.outputs.count }}"
          echo "ğŸ”— ë¦´ë¦¬ìŠ¤ í˜ì´ì§€: https://github.com/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.version }}"